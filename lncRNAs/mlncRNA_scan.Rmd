---
title: "hlncRNA_scan"
author: "Michael Soutschek"
date: "26 2 2021"
output: html_document
---


```{r}
devtools::load_all("/mnt/schratt/scanMir/")
suppressPackageStartupMessages({
  library(scanMiRData)
  library(ensembldb)
  library(AnnotationHub)
  library(BSgenome)
  library(BiocParallel)
})
```



# Get lncRNA sequences
```{r}
# Prepare
ah <- AnnotationHub()
genome <- BSgenome.Mmusculus.UCSC.mm10::BSgenome.Mmusculus.UCSC.mm10
ahid <- rev(query(ah, c("EnsDb", "GRCm38"))$ah_id)[1]
ensdb <- ah[[ahid]]
seqlevelsStyle(genome) <- "Ensembl"

# restrict to canonical chromosomes
canonical_chroms <- seqlevels(genome)[!grepl('_', seqlevels(genome))]

# Get Sequences
filt <- SeqNameFilter(canonical_chroms)
## listTxbiotypes(ensdb)
grl_lncRNA <- ensembldb::exonsBy(ensdb, by = "tx", filter = ~ tx_biotype == "lincRNA" & filt)
seqs_lncRNA <- extractTranscriptSeqs(genome,grl_lncRNA )

# Get Info
info <- data.frame(strand=unlist(unique(strand(grl_lncRNA))))
lncRNA.len <- lengths(seqs_lncRNA)
info$lncRNA.length <- lncRNA.len[row.names(info)]
mcols(seqs_lncRNA)$lncRNA.length <- lncRNA.len[names(seqs_lncRNA)]
```

# Get mods
```{r}
mods <- scanMiRData::getKdModels("mmu",c("Conserved across mammals","Conserved across vertebrates"))
mods <- KdModelList(mods)
```


# Scan
```{r}
m <- findSeedMatches(seqs_lncRNA, mods, shadow=0L,ret = "GRanges",p3.extra = TRUE, BP=MulticoreParam(8, progress=TRUE), keepMatchSeq = TRUE)
saveRDS(m,"mouse_lncRNAs_cons.miRNAs.rds")
```


# Filter for TDMD sites
```{r}
m_TDMD <- m[m$note != "-"]
m_TDMD@elementMetadata$sequence <- NULL
saveRDS(m_TDMD,"mouse_lncRNAs_cons.miRNAs_TDMD.rds")
```

