---
title: "archetypes"
author: "Pierre-Luc Germain"
date: "2/23/2021"
output: html_document
---

```{r}
suppressPackageStartupMessages({
  library(scanMiR)
  library(scanMiRData)
  library(ggplot2)
  library(ggrepel)
  library(cowplot)
  library(ggpointdensity)
  library(viridis)
})
theme_set(theme_cowplot(font_size=12, rel_large=15/14))
```

#colors
```{r}
source("../misc.R")
```



```{r}
set.seed(1234)
mods <- getKdModels("hsa",categories = NULL)
kd <- read.delim("/mnt/schratt/scanMiR_paper_scripts_old/Parameter_Optimization/data/CNN/hsa-miR-122-5p_kds.txt", colClasses = c(X12mer="character", log_kd="numeric", mir="factor", "mirseq"="factor", "aligned_type"=NULL, "best_stype"=NULL))
mod <- getKdModel(kd)
kd <- kd[grep("X",kd$X12mer,invert=TRUE),]
kd2 <- assignKdType(kd$X12mer, mod)
kd$compressed <- kd2$log_kd/1000
kd1 <- kd[sample.int(nrow(kd), 100000),]

d <- data.frame(row.names=names(mods), conservation=conservation(mods),
                correlation=sapply(mods,FUN=function(x) x$cor),
                toplogKd=sapply(mods,FUN=function(x) min(x$mer8/1000)))
d2 <- d[which(as.integer(d$conservation)>2),]
d2 <- d2[order(abs(d2$correlation-mean(d2$correlation))),]

kd <- read.delim("/mnt/schratt/enrichMiR_data/miRNA_KD_CNN/predictions/hsa/hsa-miR-24-3p_kds.txt", colClasses = c(X12mer="character", log_kd="numeric", mir="factor", "mirseq"="factor", "aligned_type"=NULL, "best_stype"=NULL))
mod <- getKdModel(kd)
kd <- kd[grep("X",kd$X12mer,invert=TRUE),]
kd2 <- assignKdType(kd$X12mer, mod)
kd$compressed <- kd2$log_kd/1000
kd2 <- kd[sample.int(nrow(kd), 100000),]

kd <- rbind(kd1, kd2)
kd$X12mer <- kd$mirseq <- NULL
p1a <- ggplot(kd, aes(x=log_kd, y=compressed) ) + 
  ggrastr::rasterize(geom_pointdensity(size=0.8, show.legend=FALSE), dpi=150) +
  labs(x=bquote("Original"~log(K[D])), y=bquote("Reconstituted"~log(K[D]))) +
  scale_colour_viridis() + theme(legend.position = "top") + 
  geom_text(data=data.frame(x=-4.8,y=2,mir=unique(kd$mir),label=paste0("r=",round(c(cor(kd1$log_kd,kd1$compressed),cor(kd2$log_kd,kd2$compressed)),3))), aes(x=x,y=y,label=label)) +
  facet_wrap(~mir, nrow=1)



p1b <- ggplot(d, aes(correlation, fill=)) + 
  geom_histogram(bins = 50, fill="darkblue") + 
  xlab("Pearson correlation with original") + ggtitle("All human miRNAs") +
  geom_vline(xintercept=c(cor(kd1$log_kd,kd1$compressed),cor(kd2$log_kd,kd2$compressed)), linetype="dashed")

p1b <- ggplot(d, aes(correlation, toplogKd)) + geom_pointdensity(show.legend=FALSE) + scale_colour_viridis() + labs(x="Correlation with original", y=bquote("Strongest "~-log(K[D]))) +
  geom_vline(xintercept=c(cor(kd1$log_kd,kd1$compressed),cor(kd2$log_kd,kd2$compressed)), linetype="dashed")
p1b <- ggExtra::ggMarginal(p1b, type="histogram",margins = "x", fill="darkblue")

p1 <- plot_grid(p1a, p1b, labels="AUTO", rel_widths = c(5,2), scale=0.95)
```


```{r}
mods <- getKdModels("hsa", categories = NULL)

ms <- t(sapply(mods, FUN=function(mod, n=15){
  mer8 <- getSeed8mers(mod$canonical.seed)
  wA <- which(substr(mer8,8,8)=="A")
  mer7 <- substr(mer8,1,7)
  As <- mod$mer8[wA]
  names(As) <- mer7[wA]
  mer.mean <- rowsum(mod$mer8[-wA],mer7[-wA])[,1]/3
  As <- As-mer.mean[names(As)]
  d <- data.frame(seed=names(mer.mean), base=mer.mean/-1000, "A"=As[names(mer.mean)]/-1000,
                  type=getMatchTypes(names(mer.mean),mod$canonical.seed), row.names=NULL)
  d <- d[head(order(d$base, decreasing=TRUE),n=n),]
  d$seed <- factor(as.character(d$seed), rev(as.character(d$seed)))
  levels(d$type) <- scanMiR:::.matchLevels(FALSE)
  gini <- ineq::Gini(1/10^(d$base))
  ent <- entropy::entropy(1/10^(d$base))
  topNC <- d[grep("g-bulged|non-canonical",d$type)[1],2]
  d <- aggregate(d[,2,drop=FALSE], by=list(type=d[,4]), na.rm=TRUE, FUN=median)
  d <- setNames(c(d[,2],topNC),c(as.character(d[,1]),"topNC"))
  c(d[c("7mer","6mer","g-bulged 6mer","6mer-m8","topNC","non-canonical")], entropy=ent, gini=gini)
}))
colnames(ms) <- c("m7","m6","gb_6mer","6mer_m8","topNC","median10NCs","entropy","gini")
ms <- as.data.frame(ms)
ms$diff7 <- ms$m7-ms$m6
ms$diff6 <- ms$m6-ms$topNC
ms$diffNC <- ms$topNC-ms$median10NCs
mod <- loess(ms$topNC~ms$m7)
ms$topNC.dev <- ms$topNC - mod$fitted
ms$miRNA <- row.names(ms)

ggplot(ms, aes(m7, topNC)) + geom_abline(slope=1, colour="grey") + geom_point(aes(colour=diffNC)) + geom_label_repel(data=ms[order(ms$topNC.dev,decreasing=TRUE)[1:10],], aes(label=miRNA), min.segment.length = 0) + labs(x="-logKD of 7mer", y="-logKD of top non-canonical", colour="Gini coefficient of the top 15 7mers") + theme(legend.position = "bottom")
```


```{r, fig.width=10, fig.height=10}
mirs <- c("hsa-miR-199a-5p","hsa-miR-124-3p", "hsa-miR-499a-5p")
#mirs <- c("hsa-miR-7-5p","hsa-miR-124-3p", "hsa-miR-499a-5p")
#mirs <- c("hsa-miR-495-3p", "hsa-miR-124-3p", "hsa-miR-92b-5p")
#mirs <- c("hsa-miR-214-5p","hsa-miR-124-3p", "hsa-miR-155-5p","hsa-miR-199a-5p")
p2 <- ggplot(ms, aes(m6, topNC)) + geom_abline(slope=1, colour="grey") + 
  geom_point(aes(colour=gini)) + 
  geom_label_repel(data=ms[mirs,], aes(label=miRNA), nudge_x=c(-0.75,-0.75,0.8), 
                   min.segment.length = 0, segment.color = "black", segment.size= 1) + 
  labs(x=bquote("median -"*log(K[D])*" of 6mers"), y=bquote("-"*log(K[D])*" of top non-canonical"), colour=bquote(atop("Gini"~(K[D])~"of the", "top 15 7mers"))) + theme(legend.position = "bottom") +
   scale_colour_viridis(breaks=scales::pretty_breaks(3))

ps <- lapply(mirs, FUN=function(x){
  p <- plotKdModel(mods[[x]], what = "seeds") + 
    theme(axis.text.y = element_text(family="mono"), 
          plot.subtitle=element_text(family="mono"))
    # scale_fill_manual(values=c("7mer"= darkgreen, "6mer"="#4477AA",
    #                             "g-bulged 6mer"="#117733", "+A"="darkred",
    #                             "non-canonical"=light,
    #                            "g-bulged 7mer"= turquoise))
  p + scale_fill_manual(values = type_cols[p$data$type])
})
ps[[1]] <- ps[[1]] + theme(legend.position = "none")
ps[[3]] <- ps[[3]] + theme(legend.position = "none")

plot_grid(p1a, p1b, p2, ps[[3]], ps[[2]], ps[[1]], 
          ncol=2, rel_widths = c(5,4), rel_heights=c(3,4,4), scale=0.95, labels="AUTO")

ggsave("Figure_2.png", height=10, width=9, bg="white")
ggsave("Figure_2.pdf", height=10, width=9, bg="white")

```

