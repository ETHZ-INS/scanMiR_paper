---
title: "scanMiR: a biochemically-based toolkit for versatile and efficient microRNA target prediction"
subtitle: "Supplementary Methods"
date: "`r format(Sys.time(), '%d %B, %Y')`"
author:
  - "Michael Soutschek"
  - "Fridolin Gross"
  - "Gerhard Schratt"
  - "Pierre-Luc Germain"

output:
  pdf_document:
    fig_width: 8
    fig_height: 6
---

# Aggregation into predicted transcript repression

The aggregation of multiple binding sites into predicted transcript repression 
is done mostly according to the model by 
[McGeary, Lin et al. (2019)](https://dx.doi.org/10.1126/science.aav1741). 
Briefly, multiple miRNA binding sites are assumed to have an additive effect on 
the transcript's decay rate that is proportional to their occupancy. The 
occupancy of AGO-bound miRNA $g$ on a mRNA $m$ with $p$ binding sites in the 
open reading frame (ORF) and $q$ in the 3' untranslated region (UTR) is given 
by the following equation:

$$
\begin{equation}
N_{m,g} = 
  \sum_{i=1}^{p}\left(\frac{a_g}{a_g + c_{\text{ORF}} 
  K_{d,i}^{\text{ORF}}}\right) +
  \sum_{j=1}^{q}\left(\frac{a_g}{a_g + K_{d,j}^{\text{3'UTR}}}\right)
\end{equation}
$$

where $a$ is the relative concentration of unbound AGO-miRNA complexes, and 
$c$ is the penalty factor for sites that are found within the ORF. scanMiR also 
includes a coefficient $e$ accounting for the effect of the 3' alignment:

$$
\begin{equation}
N_{m,g} = 
  \sum_{i=1}^{p}\left(\frac{a_g}{a_g + e_{i}c_{\text{ORF}} 
    K_{d,i}^{\text{ORF}}}\right) +
  \sum_{j=1}^{q}\left(\frac{a_g}{a_g + e_{j}K_{d,j}^{\text{3'UTR}}}\right)
\end{equation}
$$

where $e$ is the exponential of the product of the 3' alignment score and a 
global parameter ($p3$). The 3' alignment score roughly corresponds to the 
number of matched nucleotides (additionally penalizing gaps), and it is by 
default set to 0 if the number of matches is below 3 (adapted from the 
observations in Grimson et al., 2007) and capped to a maximum of 8 in order to 
account for sites with higher scores possibly leading to target-directed miRNA 
degradation (TDMD).

The repression by miRNA $g$ can then be understood as the ratio between its 
occupancy and a background occupancy term, in which the dissociation constants 
are set to that of nonspecifically bound sites (i.e. $K_d = 1.0$). More 
specifically, McGeary et al. (2019) model the repression as:

$$
\begin{equation}
N_{m,g,\text{background}} = 
  \sum_{i=1}^{p}\left(\frac{a_g}{a_g + c_{\text{ORF}}}\right) +
  \sum_{j=1}^{q}\left(\frac{a_g}{a_g + 1}\right)
\end{equation}
$$

where $b$ can be interpreted as the additional repression caused by a single 
bound AGO. Because UTR and ORF lengths have been reported to influence the 
efficacy of repression (Agarwal et al., 2015; Hausser et al., 2009), scanMiR 
allows for an additional term to take these effects into account:

$$
\text{repression}_{\text{adj}} = \text{repression}\cdot
(1+f\cdot\text{UTR.length}+h\cdot\text{ORF.length})
$$

`UTR.length` and `ORF.length` are linearly normalized so that 0 and 1 are 
respectively the 5\% and 95\% quantiles of the distribution of lengths (see 
Garcia et al. 2011; Agarwal et al. 2015). This adjustment overall leads to 
slightly improved correlations with observed repression (Suppl. Fig. 7B-C). 
Given that the effect is small except for some extreme transcripts, these 
parameters are however set to 0 by default. 

While $b$, $c$, $p3$, $f$ and $h$ are considered global parameters (i.e. the 
same for different miRNAs and transcripts and also across experimental 
contexts), $a$ is expected to be different for each miRNA in a given 
experimental condition. Values for parameters $b$ (= 1.77) and $c$ (= -1.71) 
were therefore obtained from the Biochemical Plus model of McGeary et al. 
(2019), which was optimized with the experimentally determined RBNS data. 
Parameters $p3$, $f$ and $h$ were globally fitted to maximize the correlation 
with miRNA transfection experiments from McGeary et al. (2019).

As shown by McGeary et al. (2019), the performance of the biochemical model is 
robust to changes in parameter $a$ of several orders of magnitude (see also 
Suppl. Fig. 3A-B). Furthermore, repression predictions obtained with the 
globally optimized $a$ value still outperform TargetScan substantially 
(see Fig. 3 & Suppl. Fig. 2). Therefore, scanMiR provides reasonable default 
parameters, although users can easily provide their own parameter values.

# Comparison of predicted and observed repression

For HeLa and HEK cell lines, we used the transcriptome reconstructions and 
quantifications provided by the authors in the GEO series (respectively in 
series GSE140217 and GSE140218). Given the absence of controls, both expression 
and predicted repression were normalized as described in McGeary et al. (2019). 
TargetScan7 values were obtained by running the TargetScan7 Python scripts of 
Kathy Lin (https://github.com/kslin/targetscan) with default parameters and conservation files supplied in the Git repository. The 100way Multi-Species Alignment (MAF) file of the custom reconstructed HEK transcripts of McGeary et al. (2019) was obtained by downloading alignments from the UCSC Genome Browser with mafFetch and then further processing these with “Stitch MAF blocks” from Galaxy (Blankenberg et al., 2011) and R. Common species identifiers were obtained from the NCBI Taxonomy Browser. miRNA seed and family information was downloaded from the TargetScan7 homepage (http://www.targetscan.org/vert_72/) and further processed in R to conform to the example input files. TargetScan8 occupancy scores were downloaded from the TargetScan8 homepage (http://www.targetscan.org/vert_80/).

To assess the scanMiR performance in another species, we downloaded two datasets of miRNA knockout studies performed in mice (Amin et al., 2015; Eichhorn et al., 2014). Reads were mapped to the GRCm38 genome and subsequently counted with Salmon 1.3.0 (Patro et al., 2017). logFC-values were obtained from edgeR (v. 3.32) (Robinson et al., 2010), by filtering for expressed transcripts using the filterByExpr-function and normalizing with a weighted trimmed mean of the logarithmic expression ratios of individual samples (TMM). For the miR-122 knockout dataset from Eichhorn et al. (2014), a common negative binomial dispersion was estimated since the authors performed RNA-sequencing with only one replicate. In order to correlate logFCs of these two datasets with scanMiR repression predictions, we considered only transcripts that constitute 90\% of the expressed transcripts of one gene in the specific setting, that are expressed higher than 10 TPM (Amin et al., 2015) or 0.5 TPM (Eichhorn et al., 2014), respectively, that are reported as representative transcripts in TargetScan, and that are supported with at least five 3p-seq-tags (http://www.targetscan.org/mmu_80/mmu_80_data_download/Gene_info.txt.zip). Mouse TargetScan8 scores were downloaded from http://www.targetscan.org/mmu_80/ and are based on the custom TargetScan mouse 3’UTR annotations.

# Other external datasets used

miRNA expression changes upon TDMD knockout in induced mouse neurons at day 10 of differentiation were downloaded from the supplementary data (Data S2) from Shi et al. (2020). Expression changes with an adjusted p-value smaller than 10-5 were considered significant (concurrent with the 17 significantly changing miRNAs in Fig. 4B of Shi et al. (2020)). Corresponding transcript expression levels were obtained from the study of Whipple et al. (2020). Sequenced reads were mapped  to GRCm38 and afterwards counted using Salmon (Patro et al., 2017). Putative TDMD sites are shown on transcripts with expression levels of at least 10 TPM in more than one wild-type sample of neurons at day 10 of differentiation (Fig. 5A, Supplementary Table 1) 

For the circular RNA scans, we used full circular RNA reconstructions from Zhang et al. (2021). A gtf file of the coordinates was kindly provided by the authors, containing also back-splice junction (BSJ) counts. We extracted the corresponding spliced sequences, appending the first 11 nucleotides at the end to enable the identification of sites spanning the back-splice junction.
miRNA expression levels in the brain (Fig. 5B, Fig. 6B) were calculated from the supplementary information of Chiang et al. (2010).